 


CREATE DATABASE IF NOT EXISTS SALARY;
USE SALARY;

CREATE TABLE DEPT (
    DEPTNO INT PRIMARY KEY,
    DNAME VARCHAR(30),
    DLOC VARCHAR(30)
);

CREATE TABLE EMPLOYEE (
    EMPNO INT PRIMARY KEY,
    ENAME VARCHAR(30),
    MGR_NO INT,
    HIREDATE DATE,
    SAL INT,
    DEPTNO INT,
    FOREIGN KEY (DEPTNO) REFERENCES DEPT(DEPTNO),
    FOREIGN KEY (MGR_NO) REFERENCES EMPLOYEE(EMPNO)
);

CREATE TABLE PROJECT (
    PNO INT PRIMARY KEY,
    PLOC VARCHAR(30),
    PNAME VARCHAR(30)
);

CREATE TABLE ASSIGNED_TO (
    EMPNO INT,
    PNO INT,
    JOB_ROLE VARCHAR(30),
    PRIMARY KEY (EMPNO, PNO),
    FOREIGN KEY (EMPNO) REFERENCES EMPLOYEE(EMPNO),
    FOREIGN KEY (PNO) REFERENCES PROJECT(PNO)
);

CREATE TABLE INCENTIVES (
    EMPNO INT,
    INCENTIVE_DATE DATE,
    INCENTIVE_AMOUNT INT,
    PRIMARY KEY (EMPNO, INCENTIVE_DATE),
    FOREIGN KEY (EMPNO) REFERENCES EMPLOYEE(EMPNO)
);



INSERT INTO DEPT VALUES
(10,'ACCOUNT','BANGALORE'),
(20,'SALES','MYSORE'),
(30,'IT','DELHI'),
(40,'HR','CHENNAI'),
(50,'FINANCE','MUMBAI');
SELECT *FROM DEPT;
INSERT INTO EMPLOYEE VALUES
(101,'RAJ',NULL,'2015-01-12',80000,10),
(102,'AMIT',101,'2016-03-20',60000,10),
(103,'NEHA',101,'2017-06-10',55000,20),
(104,'RAVI',102,'2018-07-18',45000,20),
(105,'SONU',103,'2019-11-25',40000,30),
(106,'TINA',103,'2020-01-07',38000,30);
SELECT *FROM EMPLOYEE;
INSERT INTO PROJECT VALUES
(501,'BANGALORE','PAYROLL'),
(502,'DELHI','ERP'),
(503,'MUMBAI','BANKING'),
(504,'CHENNAI','TRAINING'),
(505,'MYSORE','SALES_APP');
SELECT *FROM PROJECT;
INSERT INTO ASSIGNED_TO VALUES
(102,501,'TEAM LEAD'),
(103,502,'DEVELOPER'),
(104,502,'TESTER'),
(105,503,'ANALYST'),
(106,504,'CLERK');
SELECT *FROM ASSIGNED_TO;
INSERT INTO INCENTIVES VALUES
(102,'2019-01-10',5000),
(103,'2019-01-12',4500),
(104,'2019-01-15',6000),
(105,'2019-01-20',3000),
(106,'2019-01-22',5500);
SELECT *FROM INCENTIVES;


-- WEEK 5--

SELECT DISTINCT  e.EMPNO
FROM EMPLOYEE e
JOIN ASSIGNED_TO a ON e.EMPNO = a.EMPNO
JOIN PROJECT p ON a.PNO = p.PNO
WHERE p.PLOC IN ('Bengaluru', 'Hyderabad', 'Mysuru');

SELECT EMPNO
FROM EMPLOYEE
WHERE EMPNO NOT IN (SELECT EMPNO FROM INCENTIVES);

SELECT
    e.ENAME,
    e.EMPNO,
    e.DEPTNO,
    a.JOB_ROLE,
    d.DLOC AS DEPARTMENT_LOCATION,
    p.PLOC AS PROJECT_LOCATION
FROM EMPLOYEE e
JOIN DEPT d ON e.DEPTNO = d.DEPTNO
JOIN ASSIGNED_TO a ON e.EMPNO = a.EMPNO
JOIN PROJECT p ON a.PNO = p.PNO
WHERE d.DLOC = p.PLOC;
-- WEEK 6 --


SELECT E.ENAME AS MANAGER_NAME
FROM EMPLOYEE E
JOIN EMPLOYEE S ON E.EMPNO = S.MGR_NO
GROUP BY E.ENAME
HAVING COUNT(S.EMPNO) = (
    SELECT MAX(cnt)
    FROM (
        SELECT COUNT(MGR_NO) cnt
        FROM EMPLOYEE
        WHERE MGR_NO IS NOT NULL
        GROUP BY MGR_NO
    ) temp
);


SELECT M.ENAME AS MANAGER_NAME
FROM EMPLOYEE M
JOIN EMPLOYEE E ON M.EMPNO = E.MGR_NO
GROUP BY M.EMPNO, M.ENAME, M.SAL
HAVING M.SAL > AVG(E.SAL);


SELECT DISTINCT D.DNAME, M2.ENAME AS SECOND_LEVEL_MANAGER
FROM EMPLOYEE E
JOIN EMPLOYEE M1 ON E.MGR_NO = M1.EMPNO
JOIN EMPLOYEE M2 ON M1.MGR_NO = M2.EMPNO
JOIN DEPT D ON E.DEPTNO = D.DEPTNO;

SELECT E.ENAME, I.INCENTIVE_AMOUNT
FROM INCENTIVES I
JOIN EMPLOYEE E ON I.EMPNO = E.EMPNO
WHERE I.INCENTIVE_DATE LIKE '2019-01%'
ORDER BY I.INCENTIVE_AMOUNT DESC
LIMIT 1 OFFSET 1;


SELECT E.ENAME
FROM EMPLOYEE E
JOIN EMPLOYEE M ON E.MGR_NO = M.EMPNO
WHERE E.DEPTNO = M.DEPTNO;